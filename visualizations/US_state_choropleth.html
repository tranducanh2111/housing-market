<!--
Filename: US_state_choropleth.html
Author: John Iliadis - 104010553

References:
- https://observablehq.com/@d3/us-state-choropleth/2
- https://observablehq.com/@d3/zoom-to-bounding-box
-->

<!--
todo: make user inputted state outline red
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>US state choropleth</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="colorLegend.js"></script>
    <script src="utils.js"></script>
    <style>
        #plot-tooltip {
            font-family: Helvetica, sans-serif;
            background: rgba(69,77,93,.9);
            border-radius: .5rem;
            color: #fff;
            box-shadow: 0 0 5px #999999;
            display: block;
            font-size: 14px;
            padding: .2rem .4rem;
            position: absolute;
            text-overflow: ellipsis;
            white-space: pre;
            z-index: 300;
        }

        .state {
            stroke: white;
            stroke-width: 1;
        }

        .state:hover {
            stroke: yellow;
            stroke-width: 2;
        }
    </style>
</head>
<body>
<h1>How much would the same property cost in different states?</h1>
<script>

    Promise.all([d3.json('us-states.json'), d3.json('state-prices.json')])
    .then(([geoJSON, statePrices]) =>
    {
        drawChoropleth(geoJSON, statePrices);
    }).catch((error) =>
    {
        console.error(`Failed to create US state choropleth: ${error}`);
    })

    function drawChoropleth(geoJson, statePrices)
    {
        const width = 1000;
        const height = 600;

        const svg = d3.select('body')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        const priceMap = new Map(statePrices.map(d => [d['state'], d['price']]));

        const projection = d3.geoAlbersUsa().scale([1000]).translate([width/2, height/2]);
        const path = d3.geoPath().projection(projection);

        const minHousePrice = d3.min(statePrices, d => d['price']);
        const maxHousePrice = d3.max(statePrices, d => d['price']);
        const colorScale = d3.scaleSequential([minHousePrice, maxHousePrice], d3.interpolateBlues)

        const zoom = d3.zoom()
            .scaleExtent([1, 6])
            .on('zoom', zoomed);

        svg.call(zoom);

        const g = svg.append('g');

        const states = g.selectAll('path')
            .data(geoJson['features'])
            .enter()
            .append('path')
            .attr('class', 'state')
            .attr('d', path)
            .attr('id', getStateName)
            .attr('fill', getStateColor);

        states.on('click', (event) => { event.stopPropagation(); });

        const tooltip = d3.select('body')
            .append('div')
            .attr('id', 'plot-tooltip')
            .style('visibility', 'hidden');

        states.on('mouseover', (event, d) =>
        {
            d3.select(event.target).raise();

            const state = getStateName(d);
            let price = getStatePrice(d);
            let tooltipText = `No data for ${state}`;

            if (price !== -1)
            {
                tooltipText = `State: ${state}\nPrice: ${formatPrice(price)} USD`;
            }

            tooltip.style('visibility', 'visible')
                .text(tooltipText);
        });

        states.on('mousemove', (event) =>
        {
            tooltip.style('top', event.pageY - 20 + 'px')
                .style('left', event.pageX + 20 + 'px');
        });

        states.on('mouseout', (event) =>
        {
            d3.select(event.target).attr('stroke-width', 0);
            tooltip.style('visibility', 'hidden');
        });

        svg.on('click', reset);

        // add color legend
        svg.append('g')
            .attr('id', 'choropleth-legend')
            .attr('transform', 'translate(610, 20)')
            .append(() => Legend(colorScale, {title: 'Price (USD)', width: 260}));

        function getStateName(d)
        {
            return d['properties']['NAME'];
        }

        function getStatePrice(d)
        {
            return priceMap.get(getStateName(d)) || -1;
        }

        function getStateColor(d)
        {
            return colorScale(getStatePrice(d));
        }

        function zoomed(event)
        {
            g.attr('transform', event.transform);
        }

        function reset()
        {
            svg.transition().duration(500).call(
                zoom.transform,
                d3.zoomIdentity,
                d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
            );
        }
    }

</script>
</body>
</html>